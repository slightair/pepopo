!function(){var a,b,c,d,e,f,g,h={}.hasOwnProperty,i=function(a,b){function c(){this.constructor=a}for(var d in b)h.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},j=function(a,b){return function(){return a.apply(b,arguments)}};window.Pepopo={},$(function(){return Pepopo.Tracks=new Pepopo.TrackList,Pepopo.Tracks.add({frequency:220}),Pepopo.Tracks.add({frequency:440}),Pepopo.Tracks.add({frequency:880}),Pepopo.Machine=new Pepopo.MachineView}),Pepopo.Note=function(b){function c(){return a=c.__super__.constructor.apply(this,arguments)}return i(c,b),c.prototype.defaults=function(){return{enable:100*Math.random()>50,noteLength:.25}},c.prototype.schedule=function(a,b){var c,d,e,f;return e=this.get("noteLength"),c=Pepopo.Machine.context,d=c.createGain(),d.gain.value=.3,d.gain.setTargetAtTime(0,b,e),d.connect(Pepopo.Machine.masterGain),f=c.createOscillator(),f.connect(d),f.frequency.value=a,f.start(b),f.stop(b+e)},c}(Backbone.Model),Pepopo.NoteView=function(a){function c(){return b=c.__super__.constructor.apply(this,arguments)}return i(c,a),c.prototype.tagName="button",c.prototype.className="pepopo-machine-note btn",c.prototype.render=function(){return this.$el.html(_.template($("#pepopo-machine-note-template").html(),this.model.toJSON())),this.model.get("enable")&&$(this.$el).addClass("btn-primary"),this},c}(Backbone.View),Pepopo.NoteList=function(a){function b(){return c=b.__super__.constructor.apply(this,arguments)}return i(b,a),b.prototype.model=Pepopo.Note,b}(Backbone.Collection),Pepopo.Track=function(a){function b(){return d=b.__super__.constructor.apply(this,arguments)}return i(b,a),b.prototype.defaults=function(){var a;return{frequency:440,order:Pepopo.Tracks.nextOrder(),notes:new Pepopo.NoteList(function(){var b,c;for(c=[],a=b=1;16>=b;a=++b)c.push({track:this.order,order:a});return c}.call(this))}},b.prototype.schedule=function(a,b){var c,d;return c=this.get("frequency"),d=this.get("notes").models[a],d.get("enable")?d.schedule(c,b):void 0},b}(Backbone.Model),Pepopo.TrackView=function(a){function b(){return e=b.__super__.constructor.apply(this,arguments)}return i(b,a),b.prototype.className="pepopo-machine-track",b.prototype.render=function(){var a,b=this;return this.$el.html(_.template($("#pepopo-machine-track-template").html(),this.model.toJSON())),a=this.model.get("notes"),a&&a.each(function(a){var c;return c=new Pepopo.NoteView({model:a}),$(b.$el).children(".pepopo-machine-notes").append(c.render().el)}),this},b}(Backbone.View),Pepopo.TrackList=function(a){function b(){return f=b.__super__.constructor.apply(this,arguments)}return i(b,a),b.prototype.model=Pepopo.Track,b.prototype.nextOrder=function(){return this.length?this.last().get("order")+1:1},b}(Backbone.Collection),Pepopo.MachineView=function(a){function b(){return this.schedule=j(this.schedule,this),g=b.__super__.constructor.apply(this,arguments)}return i(b,a),b.prototype.initialize=function(){return this.context=new webkitAudioContext,this.masterGain=this.context.createGain(),this.masterGain.connect(this.context.destination),this.masterGain.gain.value=.4,this.nextNoteTime=0,this.currentNote=0,this.tempo=60,this.noteMax=16,this.timer=null,this.render()},b.prototype.el="#pepopo-machine",b.prototype.events={"click #play-pepopo-machine":"play","click #stop-pepopo-machine":"stop"},b.prototype.render=function(){return Pepopo.Tracks?Pepopo.Tracks.each(function(a){var b;return b=new Pepopo.TrackView({model:a}),$("#pepopo-machine-tracks").append(b.render().el)}):void 0},b.prototype.play=function(){return this.timer?void 0:(this.nextNoteTime=this.context.currentTime,this.currentNote=0,this.schedule())},b.prototype.stop=function(){return clearInterval(this.timer),this.timer=null},b.prototype.schedule=function(){for(var a,b=this;this.nextNoteTime<this.context.currentTime+.2;)Pepopo.Tracks.each(function(a){return a.schedule(b.currentNote,b.nextNoteTime)}),a=60/this.tempo,this.nextNoteTime+=.25*a,this.currentNote++,this.currentNote>=this.noteMax&&(this.currentNote=0);return this.timer=setTimeout(this.schedule,0)},b}(Backbone.View)}.call(this);
/*
//@ sourceMappingURL=public/js/pepopo-min.js.map
*/